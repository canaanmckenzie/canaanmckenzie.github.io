<!docytpe html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name = "viewport" content="width=device-width, initial-scale=1.0">
        <link href="/assets/css/style.css" rel="stylesheet">
        <link href="/assets/css/code.css" rel="stylesheet" />
        <link href="/assets/css/katex.min.css" rel="stylesheet"/>
        <title>Irregular Library</title>
    </head>
    <body>
        <div class="titlecard">
            <a href="/">~/</a> | <a href="/feed.xml">rss</a>
        </div>
        <h1>Irregular Library</h1>
<p>
    2022 02 05 </br>
    
    <a href="/tags/python">#python</a>
    
</p>
<p>Python script for generating a randomly selected libary from Project Gutenberg's daily uploads. <a href="https://github.com/canaanmckenzie/random_bookshelf">Source</a>.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os<br><span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request<br><span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>ElementTree <span class="token keyword">as</span> ET<br><span class="token keyword">from</span> datetime <span class="token keyword">import</span> date<br><span class="token keyword">import</span> random<br><br><span class="token keyword">def</span> <span class="token function">get_random_book</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token comment">#get today's date</span><br>    today <span class="token operator">=</span> date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span><br><br>    <span class="token comment">#open text file</span><br>    file_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'daily_uploads/</span><span class="token interpolation"><span class="token punctuation">{</span>today<span class="token punctuation">}</span></span><span class="token string">.txt'</span></span><br>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"error: 'file_name' does not exist"</span></span><span class="token punctuation">)</span><br>        <span class="token keyword">return</span> <span class="token boolean">None</span><br>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf'</span><span class="token punctuation">,</span>errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span><br>        lines <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <br>    <span class="token comment">#pick a random line from the file</span><br>    random_line <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>lines<span class="token punctuation">)</span><br><br>    <span class="token comment">#parse the line to find the book number - need to find a more robust way to do this but should work</span><br>    book_number <span class="token operator">=</span> <span class="token boolean">None</span><br>    title <span class="token operator">=</span> <span class="token boolean">None</span><br>    parts <span class="token operator">=</span> random_line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span><br>        title <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">)</span><br>        url <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><br>        book_number <span class="token operator">=</span> url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><br>    <span class="token keyword">return</span> book_number<span class="token punctuation">,</span> title<br><br><span class="token keyword">def</span> <span class="token function">retrieve_book</span><span class="token punctuation">(</span>book_number<span class="token punctuation">,</span>title<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token comment">#create an irregular_library folder</span><br>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'irregular_library'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">'irregular_library'</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'irregular_library/</span><span class="token interpolation"><span class="token punctuation">{</span>today<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'irregular_library/</span><span class="token interpolation"><span class="token punctuation">{</span>today<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><br><br>    <span class="token comment">#url to books text file</span><br>    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'https://www.gutenberg.org/cache/epub/</span><span class="token interpolation"><span class="token punctuation">{</span>book_number<span class="token punctuation">}</span></span><span class="token string">/pg</span><span class="token interpolation"><span class="token punctuation">{</span>book_number<span class="token punctuation">}</span></span><span class="token string">.txt'</span></span><br>    <br>    <span class="token comment">#error check book exists</span><br>    <span class="token keyword">try</span><span class="token punctuation">:</span><br>        <span class="token keyword">with</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span><br>            response<span class="token punctuation">.</span>status_code <span class="token operator">=</span> <span class="token number">200</span><br>    <span class="token keyword">except</span> urllib<span class="token punctuation">.</span>error<span class="token punctuation">.</span>HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span><br>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error: book with number </span><span class="token interpolation"><span class="token punctuation">{</span>book_number<span class="token punctuation">}</span></span><span class="token string"> does not exist as a text file"</span></span><span class="token punctuation">)</span><br>        <span class="token keyword">return</span><br>    <br>    <span class="token comment">#download books text file and add it to the irregular_libray</span><br>    response <span class="token operator">=</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">)</span><br>    file_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"irregular_library/</span><span class="token interpolation"><span class="token punctuation">{</span>today<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">.txt"</span></span><br>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span><br>            <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <br>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string"> has been saved"</span></span><span class="token punctuation">)</span><br><br><br><span class="token comment">#create a folder to store the daily uploads if it doesn't exist</span><br><span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'daily_uploads'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'daily_uploads'</span><span class="token punctuation">)</span><br><br><span class="token comment">#download rss feed</span><br>url <span class="token operator">=</span> <span class="token string">'https://www.gutenberg.org/cache/epub/feeds/today.rss'</span><br>urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlretrieve<span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token string">'today.rss'</span><span class="token punctuation">)</span><br><br><span class="token comment">#parse the rss feed</span><br>tree <span class="token operator">=</span> ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token string">'today.rss'</span><span class="token punctuation">)</span><br>root <span class="token operator">=</span> tree<span class="token punctuation">.</span>getroot<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>today <span class="token operator">=</span> date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">#open a text file to store the book title and urls</span><br>file_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'daily_uploads/</span><span class="token interpolation"><span class="token punctuation">{</span>today<span class="token punctuation">}</span></span><span class="token string">.txt'</span></span><br><br><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span><br>    <span class="token comment">#find &lt;items></span><br>    items <span class="token operator">=</span> root<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'channel/item'</span><span class="token punctuation">)</span><br><br>    <span class="token comment">#loop through each upload</span><br>    <span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span><br>        title <span class="token operator">=</span> item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<br>        <span class="token comment">#get the url of books plaintext file</span><br>        links <span class="token operator">=</span> item<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><br>        file_url <span class="token operator">=</span> <span class="token boolean">None</span><br>        <span class="token keyword">for</span> link <span class="token keyword">in</span> links<span class="token punctuation">:</span><br>            <span class="token keyword">if</span> link<span class="token punctuation">.</span>text<span class="token punctuation">:</span><br>                file_url <span class="token operator">=</span> link<span class="token punctuation">.</span>text<br>                <span class="token keyword">break</span><br>        <span class="token keyword">if</span> file_url <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span><br>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"no URL found for '</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">'"</span></span><span class="token punctuation">)</span><br>            <span class="token keyword">continue</span><br><br>        <span class="token comment">#write the title and URL to the text file</span><br>        <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">'\t</span><span class="token interpolation"><span class="token punctuation">{</span>file_url<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span><br><span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><br>os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'today.rss'</span><span class="token punctuation">)</span><br><br><span class="token comment">#get random book number from text file - change this to get book txt file from project Gutenberg</span><br>book_number<span class="token punctuation">,</span> title <span class="token operator">=</span> get_random_book<span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">if</span> book_number <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span><br>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Book of the day for </span><span class="token interpolation"><span class="token punctuation">{</span>today<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>book_number<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br>    retrieve_book<span class="token punctuation">(</span>book_number<span class="token punctuation">,</span> title<span class="token punctuation">)</span><br><span class="token keyword">else</span><span class="token punctuation">:</span><br>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error getting book number"</span><span class="token punctuation">)</span></code></pre>

</html>