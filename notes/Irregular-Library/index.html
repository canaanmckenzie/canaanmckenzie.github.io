<!DOCTYPE html>
<html>
  <head>
<meta charset="utf-8">
<meta name = "viewport" content="width=device-width, initial-scaled=1.0"/>
<title>Irregular Library</title>
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="icon" href="/assets/images/favicon.ico">
<link type="application/atom+xml" rel="alternate" href="/feed.xml" />
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Irregular Library</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Irregular Library" />
<meta name="author" content="Canaan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Python script for generating a randomly selected libary from Project Gutenberg’s daily uploads. Source." />
<meta property="og:description" content="Python script for generating a randomly selected libary from Project Gutenberg’s daily uploads. Source." />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-05T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Irregular Library" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Canaan"},"dateModified":"2019-10-05T00:00:00-04:00","datePublished":"2019-10-05T00:00:00-04:00","description":"Python script for generating a randomly selected libary from Project Gutenberg’s daily uploads. Source.","headline":"Irregular Library","mainEntityOfPage":{"@type":"WebPage","@id":"/notes/Irregular-Library/"},"url":"/notes/Irregular-Library/"}</script>
<!-- End Jekyll SEO tag -->


</head>
  <body class="full-width">
    <header>
    <nav class= "group">
        <a href="/"><img class="badge" src="/assets/img/ghosty.png" alt="CM"></a>
        <a href="/">Home</a>
        <a href="/about">about</a>
    </nav>
</header>
    <article>
      <h1>Irregular Library</h1>
<p class="subtitle">October 5, 2019</p>


<p>Python script for generating a randomly selected libary from Project Gutenberg’s daily uploads. <a href="https://github.com/canaanmckenzie/random_bookshelf">Source</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">urllib.request</span>
<span class="kn">import</span> <span class="n">xml.etree.ElementTree</span> <span class="k">as</span> <span class="n">ET</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="n">random</span>

<span class="k">def</span> <span class="nf">get_random_book</span><span class="p">():</span>
    <span class="c1">#get today's date
</span>    <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d'</span><span class="p">)</span>

    <span class="c1">#open text file
</span>    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'daily_uploads/</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s">.txt'</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"error: 'file_name' does not exist"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="s">'r'</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">'utf'</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">readlines</span><span class="p">()</span>
    
    <span class="c1">#pick a random line from the file
</span>    <span class="n">random_line</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="c1">#parse the line to find the book number - need to find a more robust way to do this but should work
</span>    <span class="n">book_number</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">title</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">random_line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">strip</span><span class="p">().</span><span class="nf">rstrip</span><span class="p">(</span><span class="s">"'"</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span>
        <span class="n">book_number</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">book_number</span><span class="p">,</span> <span class="n">title</span>

<span class="k">def</span> <span class="nf">retrieve_book</span><span class="p">(</span><span class="n">book_number</span><span class="p">,</span><span class="n">title</span><span class="p">):</span>
    <span class="c1">#create an irregular_library folder
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s">'irregular_library'</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="s">'irregular_library'</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="sa">f</span><span class="s">'irregular_library/</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s">'</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s">'irregular_library/</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

    <span class="c1">#url to books text file
</span>    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'https://www.gutenberg.org/cache/epub/</span><span class="si">{</span><span class="n">book_number</span><span class="si">}</span><span class="s">/pg</span><span class="si">{</span><span class="n">book_number</span><span class="si">}</span><span class="s">.txt'</span>
    
    <span class="c1">#error check book exists
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="k">except</span> <span class="n">urllib</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error: book with number </span><span class="si">{</span><span class="n">book_number</span><span class="si">}</span><span class="s"> does not exist as a text file"</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1">#download books text file and add it to the irregular_libray
</span>    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"irregular_library/</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">.txt"</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">'w+'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="nb">file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
    
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s"> has been saved"</span><span class="p">)</span>


<span class="c1">#create a folder to store the daily uploads if it doesn't exist
</span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s">'daily_uploads'</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="s">'daily_uploads'</span><span class="p">)</span>

<span class="c1">#download rss feed
</span><span class="n">url</span> <span class="o">=</span> <span class="s">'https://www.gutenberg.org/cache/epub/feeds/today.rss'</span>
<span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">'today.rss'</span><span class="p">)</span>

<span class="c1">#parse the rss feed
</span><span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s">'today.rss'</span><span class="p">)</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="p">.</span><span class="nf">getroot</span><span class="p">()</span>

<span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d'</span><span class="p">);</span>

<span class="c1">#open a text file to store the book title and urls
</span><span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'daily_uploads/</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s">.txt'</span>

<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">'w+'</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="c1">#find &lt;items&gt;
</span>    <span class="n">items</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="s">'channel/item'</span><span class="p">)</span>

    <span class="c1">#loop through each upload
</span>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="s">'title'</span><span class="p">).</span><span class="n">text</span>
        <span class="c1">#get the url of books plaintext file
</span>        <span class="n">links</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="s">'link'</span><span class="p">)</span>
        <span class="n">file_url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">file_url</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="n">text</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">file_url</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"no URL found for '</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1">#write the title and URL to the text file
</span>        <span class="nb">file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">'</span><span class="se">\t</span><span class="si">{</span><span class="n">file_url</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="s">'today.rss'</span><span class="p">)</span>

<span class="c1">#get random book number from text file - change this to get book txt file from project Gutenberg
</span><span class="n">book_number</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="nf">get_random_book</span><span class="p">()</span>
<span class="k">if</span> <span class="n">book_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Book of the day for </span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s"> is </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">book_number</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="nf">retrieve_book</span><span class="p">(</span><span class="n">book_number</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Error getting book number"</span><span class="p">)</span>
</code></pre></div></div>

    </article>
    <div class="footer">
    <span>&copy 2014-2023 Canaan McKenzie. <a href="/feed.xml">Subscribe</a> via RSS</span>
</div>
  </body>
</html>